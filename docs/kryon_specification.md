# Kryon Binary Format Specification (KRB) v1.0

## Kryon Ecosystem Overview

Kryon consists of two distinct formats:

1. **Kryon Source Language (.kry)**:
   - A human-readable, text-based language for defining user interfaces.
   - Designed for developers to write UI layouts, styles, and behaviors in a simple, expressive syntax.
   - Files use the `.kry` extension (e.g., `interface.kry`).
   - Compiled into the binary format for deployment.

2. **Kryon Binary Format (.krb)**:
   - A compact, platform-independent binary representation of the UI, as detailed in this specification.
   - Generated by compiling Kryon source files.
   - Files use the `.krb` extension (e.g., `interface.krb`) to distinguish them from source files.
   - Optimized for parsing and rendering on resource-constrained systems.

The Kryon workflow typically involves:
- Writing UI definitions in the Kryon source language (`.kry`).
- Compiling these into the Kryon binary format (`.krb`) using a Kryon compiler.
- Deploying the `.krb` files to target platforms for rendering.

## Design Goals
- **Universal Compatibility**: Works across diverse computing environments, including 8-bit systems like Uxn
- **Compact Representation**: Minimal memory footprint without sacrificing features
- **Performance-Oriented**: Fast parsing, efficient rendering, minimal runtime overhead
- **Feature Complete**: Match or exceed HTML/CSS/JS capabilities where appropriate
- **Extensible**: Designed for future growth while maintaining backward compatibility
- **Stack-Friendly**: Suitable for minimal environments with no dynamic allocation

## File Structure

[File Header]          # Format identification and section offsets
[Element Blocks]       # Starts with App (if present), followed by other elements
[Style Blocks]         # Reusable styles (optional)
[Animation Table]      # Transitions and keyframe animations (optional)
[String Table]         # Text content and identifiers, includes window title
[Resource Table]       # External resources like images and videos (optional)

## 1. File Header (38 bytes)

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0      | 4    | Magic Number   | Format identifier         | `0x4B 0x52 0x42 0x31` ("KRB1") |
| 4      | 2    | Version        | Format version            | `0x01 0x00` (1.0) |
| 6      | 2    | Flags          | Format capabilities       | `0x47 0x00` (styles, animations, resources, app) |
| 8      | 2    | Element Count  | Number of elements        | `0x05 0x00` (5 elements) |
| 10     | 2    | Style Count    | Number of styles          | `0x02 0x00` (2 styles) |
| 12     | 2    | Animation Count| Number of animations      | `0x03 0x00` (3 animations) |
| 14     | 2    | String Count   | Number of strings         | `0x0A 0x00` (10 strings) |
| 16     | 2    | Resource Count | Number of resources       | `0x01 0x00` (1 resource) |
| 18     | 4    | Element Offset | Byte offset to elements   | `0x26 0x00 0x00 0x00` (38) |
| 22     | 4    | Style Offset   | Byte offset to styles     | `0xC8 0x00 0x00 0x00` (200) |
| 26     | 4    | Animation Offset | Byte offset to animations | `0xFA 0x00 0x00 0x00` (250) |
| 30     | 4    | String Offset  | Byte offset to strings    | `0x40 0x01 0x00 0x00` (320) |
| 34     | 4    | Total Size     | File size in bytes        | `0xB4 0x01 0x00 0x00` (436) |

- **Endianness**: Little-endian for multi-byte values

- **Flags**:
  - Bit 0: Has styles
  - Bit 1: Has animations
  - Bit 2: Has resources
  - Bit 3: Compressed (string table uses dictionary compression)
  - Bit 4: Fixed-point (uses 8.8 fixed-point for percentages)
  - Bit 5: Extended color (uses RGB8 instead of palette indices)
  - Bit 6: Has App element (indicates presence of App element)
  - Bit 7-15: Reserved
 
## 2. Element Blocks

Each element represents a UI component with hierarchical structure. The first element may be an `App` element if the Has App flag is set.

### Element Header (16 bytes)

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Type | Element type | `0x00` (App) or `0x01` (Container) |
| 1 | 1 | ID | String table index or 0 | `0x01` ("mainApp") |
| 2 | 2 | Position X | X coordinate or offset | `0x00 0x00` (0) |
| 4 | 2 | Position Y | Y coordinate or offset | `0x00 0x00` (0) |
| 6 | 2 | Width | Width in pixels or logical units | `0x20 0x03` (800) |
| 8 | 2 | Height | Height in pixels or logical units | `0x58 0x02` (600) |
| 10 | 1 | Layout | Layout properties | `0x00` (Default) |
| 11 | 1 | Style ID | Style reference or 0 | `0x01` (Style #1) |
| 12 | 1 | Property Count | Number of properties | `0x06` (6 properties) |
| 13 | 1 | Child Count | Number of children | `0x01` (1 child) |
| 14 | 1 | Event Count | Number of events | `0x00` (0 events) |
| 15 | 1 | Animation Count | Number of animations | `0x00` (0 animations) |

- **Style ID**: For `App`, this applies a style to the application window (e.g., background color) and serves as the default style for all child elements unless they specify their own `Style ID`.

**Element Types**:
- **Core Elements** (0x00–0x0F):
  - `0x00`: App (application root element)
  - `0x01`: Container (div-like, generic container)
  - `0x02`: Text (span/p-like, text content)
  - `0x03`: Image (image display)
  - `0x04`: Canvas (raw drawing surface)
  - `0x05`–`0x0F`: Reserved for future core elements

- **Interactive Elements** (0x10–0x1F):
  - `0x10`: Button (clickable element)
  - `0x11`: Input (text input field)
  - `0x12`–`0x1F`: Reserved for future interactive elements (e.g., Checkbox, Slider)

- **Structural Elements** (0x20–0x2F):
  - `0x20`: List (vertical/horizontal list)
  - `0x21`: Grid (table-like layout)
  - `0x22`: Scrollable (scrollable container)
  - `0x23`–`0x2F`: Reserved for future structural elements (e.g., Stack, TabView)

- **Specialized Elements** (0x30–0xFF):
  - `0x30`: Video (video playback element)
  - `0x31`–`0xFF`: Custom (defined by name in the string table, e.g., platform-specific or user-defined components)

**Layout Byte**:
- Bits 0-1: Direction (00=Row, 01=Column, 10=RowReverse, 11=ColumnReverse)
- Bits 2-3: Alignment (00=Start, 01=Center, 10=End, 11=SpaceBetween)
- Bit 4: Wrap (0=NoWrap, 1=Wrap)
- Bit 5: Grow (0=Fixed, 1=Grow)
- Bit 6: Absolute (0=FlowLayout, 1=AbsolutePosition)
- Bit 7: Reserved

### Properties

Properties follow the element header, with `Property Count` entries:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Property ID | Property identifier | `0x01` (BackgroundColor) |
| 1 | 1 | Value Type | Data type | `0x03` (Color) |
| 2 | 1 | Size | Value size in bytes | `0x04` (4 bytes) |
| 3 | Variable | Value | Property value | `0xFF 0x00 0x00 0xFF` (Red) |

- If BorderWidth uses Value Type 0x08 (EdgeInsets), it defines individual border widths for each side (top, right, bottom, left) in that order, 4 bytes total.
- Renderer should use EdgeInsets if present; otherwise, fall back to uniform BorderWidth (0x01 Byte).

**Property IDs**:
- `0x00`: Invalid
- `0x01`: BackgroundColor
- `0x02`: ForegroundColor
- `0x03`: BorderColor
- `0x04`: BorderWidth
- `0x05`: BorderRadius
- `0x06`: Padding
- `0x07`: Margin
- `0x08`: TextContent
- `0x09`: FontSize
- `0x0A`: FontWeight
- `0x0B`: TextAlignment
- `0x0C`: ImageSource
- `0x0D`: Opacity
- `0x0E`: ZIndex
- `0x0F`: Visibility
- `0x10`: Gap
- `0x11`: MinWidth
- `0x12`: MinHeight
- `0x13`: MaxWidth
- `0x14`: MaxHeight
- `0x15`: AspectRatio
- `0x16`: Transform
- `0x17`: Shadow
- `0x18`: Overflow
- `0x19`: Custom (uses a string table reference)
- **App-Specific Properties**:
  - `0x20`: WindowWidth (Short, 2 bytes)
  - `0x21`: WindowHeight (Short, 2 bytes)
  - `0x22`: WindowTitle (String index, 1 byte)
  - `0x23`: Resizable (Byte, 1 byte: 0=false, 1=true)
  - `0x24`: KeepAspect (Byte, 1 byte: 0=false, 1=true)
  - `0x25`: ScaleFactor (Percentage, 2 bytes fixed-point 8.8)
  - `0x26`: Icon (Resource index, 1 byte)
  - `0x27`: Version (String index, 1 byte)
  - `0x28`: Author (String index, 1 byte)
- `0x29`-`0xFF`: Reserved

**Value Types**:
- `0x00`: None
- `0x01`: Byte (8-bit)
- `0x02`: Short (16-bit)
- `0x03`: Color (R,G,B,A or palette index)
- `0x04`: String (index to string table)
- `0x05`: Resource (index to resource table)
- `0x06`: Percentage (Fixed-point 0.0-1.0)
- `0x07`: Rectangle (x,y,w,h)
- `0x08`: EdgeInsets (top,right,bottom,left)
- `0x09`: Enum (predefined options)
- `0x0A`: Vector (x,y coordinates)
- `0x0B`: Custom
- `0x0C`-`0xFF`: Reserved

### Events

Events follow properties, with `Event Count` entries:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Event Type | Event identifier | `0x01` (Click) |
| 1 | 1 | Callback ID | String table index for callback | `0x03` ("onClickHandler") |

**Event Types**:
- `0x00`: None
- `0x01`: Click
- `0x02`: Press
- `0x03`: Release
- `0x04`: LongPress
- `0x05`: Hover
- `0x06`: Focus
- `0x07`: Blur
- `0x08`: Change
- `0x09`: Submit
- `0x0A`: Custom (uses a string table reference)
- `0x0B`-`0xFF`: Reserved

### Animation References

Animation references follow events, with `Animation Count` entries:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Animation Index | Index into animation table | `0x00` (Animation #0) |
| 1 | 1 | Trigger | Event that activates animation | `0x01` (Click) |

**Trigger Types**:
- `0x00`: Auto (starts automatically)
- `0x01`: Click
- `0x02`: Hover
- `0x03`: Focus
- `0x04`: Load
- `0x05`: Custom (uses a string table reference)
- `0x06`-`0xFF`: Reserved

### Child References

Child references follow animation references, with `Child Count` entries:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0      | 2    | Child Offset | Byte offset from the start of this element to the child element | `0x10 0x00` (16 bytes ahead) |

## Notes on App Element
- The `App` element, if present (Flag Bit 6 = 1), must be the first element in the Element Blocks section.
- It defines application-wide properties such as window dimensions, title, scaling, and metadata (icon, version, author).
- The `Style ID` field (offset 11) applies a style directly to the `App` element (e.g., window background) and cascades to all child elements as their default style unless they specify their own `Style ID`.
- Renderers should use these properties to initialize the application window and apply the cascading style hierarchy.

## 3. Style Blocks

Style blocks define reusable sets of properties.

### Style Header

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | ID | Style identifier | `0x01` (Style #1) |
| 1 | 1 | Name Index | String table index for name | `0x02` ("buttonStyle") |
| 2 | 1 | Property Count | Number of properties | `0x04` (4 properties) |
| 3 | Variable | Properties | Property definitions | (See Property Format) |

## 4. Animation Table

Supports both transitions and keyframe animations. Note: In 8-bit environments, compilers may convert durations to frames (e.g., 60fps) if Flags Bit 6 = 0.

### Transition Animation

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Type | Animation type | `0x01` (Transition) |
| 1 | 1 | ID | Animation identifier | `0x00` (Animation #0) |
| 2 | 2 | Duration | Duration in milliseconds | `0xE8 0x03` (1000ms) |
| 3 | 1 | Timing Function | Easing curve | `0x01` (EaseInOut) |
| 4 | 1 | Property Count | Number of properties | `0x01` (1 property) |
| 5 | Variable | Properties | Properties with start/end values | (See below) |

For each property:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Property ID | Property to animate | `0x01` (BackgroundColor) |
| 1 | 1 | Value Type | Data type | `0x03` (Color) |
| 2 | 1 | Size | Value size in bytes | `0x04` (4 bytes) |
| 3 | Variable | Start Value | Initial value | `0xFF 0x00 0x00 0xFF` (Red) |
| 3+Size | Variable | End Value | Target value | `0x00 0x00 0xFF 0xFF` (Blue) |

**Timing Functions**:
- `0x00`: Linear
- `0x01`: EaseInOut
- `0x02`: EaseIn
- `0x03`: EaseOut
- `0x04`: Spring
- `0x05`: Bounce
- `0x06`: Custom
- `0x07`-`0xFF`: Reserved

### Keyframe Animation

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Type | Animation type | `0x02` (Keyframe) |
| 1 | 1 | ID | Animation identifier | `0x01` (Animation #1) |
| 2 | 2 | Duration | Duration in milliseconds | `0xD0 0x07` (2000ms) |
| 3 | 1 | Repeat Mode | How animation repeats | `0x01` (Loop) |
| 4 | 1 | Keyframe Count | Number of keyframes | `0x03` (3 keyframes) |
| 5 | Variable | Keyframes | Keyframe definitions | (See below) |

For each keyframe:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 2 | Time Offset | Time in ms from start | `0x00 0x00` (0ms) |
| 2 | 1 | Property ID | Property to animate | `0x0D` (Opacity) |
| 3 | 1 | Value Type | Data type | `0x06` (Percentage) |
| 4 | 1 | Size | Value size in bytes | `0x01` (1 byte) |
| 5 | Variable | Value | Target value | `0xFF` (100%) |

**Repeat Modes**:
- `0x00`: None (play once)
- `0x01`: Loop
- `0x02`: Alternate
- `0x03`: Count (specified number of times)
- `0x04`-`0xFF`: Reserved

## 5. String Table

Central storage for all text strings used in the UI.

### String Table Header

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 2 | String Count | Number of strings | `0x0A 0x00` (10 strings) |
| 2 | Variable | Strings | Length-prefixed strings | (See below) |

For each string:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Length | String length in bytes | `0x0B` (11 bytes) |
| 1 | Variable | UTF-8 Bytes | String data | `"Hello World"` |

## 6. Resource Table

References to external resources like images.

### Resource Table Header

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 2 | Resource Count | Number of resources | `0x01 0x00` (1 resource) |
| 2 | Variable | Resources | Resource entries | (See below) |

For each resource:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Type | Resource type | `0x01` (Image) |
| 1 | 1 | Name Index | String table index for name | `0x04` ("background.png") |
| 2 | 1 | Format | Format details | `0x00` (External) |
| 3 | Variable | Data | Format-specific data | (See below) |

**Resource Types**:
- `0x00`: None
- `0x01`: Image
- `0x02`: Font
- `0x03`: Sound
- `0x04`: Video
- `0x05`: Custom (uses a string table reference)
- `0x06`-`0xFF`: Reserved

For external resources (Format=0x00):
- Data is a string table index to the resource path/URL.

For inline resources (Format=0x01):
- Data includes size (2 bytes) followed by the raw binary data.

## Stack-Based Considerations

For stack-based or resource-constrained environments (e.g., Uxn):
1. **Use 8-bit indices** where possible (e.g., Style ID, Animation Index)
2. **Simplify numeric values**:
   - For color: Use palette indices (0-255) instead of RGBA
   - For positions: Use 8-bit coordinates for small screens
   - For time: Use frames (60fps) instead of milliseconds
3. **Fixed element sizes** to simplify parsing
4. **Precomputed layouts** when absolute positioning is used
5. **Prefer Small File Mode**: Use a 2-byte Total Size (Flags Bit 6 = 0) to keep files under 65,535 bytes, fitting 8-bit address spaces like Uxn.

## Optimizations for Constrained Systems

1. **String Table Compression**:
  - Dictionary-based compression for common tokens
  - Optional: Run-length encoding for repetitive text

2. **Animation Optimization**:
  - Simplified easing (linear, step)
  - Pre-computed keyframes for common durations

3. **Layout Simplification**:
  - Fixed-size elements where possible
  - Minimal or no flexbox features

4. **Memory-Efficient Parsing**:
  - Stream parsing with fixed-size buffer (64-256 bytes)
  - Sequential processing without tree building

## HTML/CSS Equivalence

This format maps elegantly to web concepts:

- **Elements** = HTML tags
- **Properties** = HTML attributes + CSS properties
- **Styles** = CSS classes
- **Animations** = CSS transitions + @keyframes
- **Events** = JavaScript event listeners

## Advanced Features

### Reactive Binding

For more capable platforms, Kryon can support data binding:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Binding Type | Type of binding | `0x01` (Property) |
| 1 | 1 | Data Path | String index to data path | `0x05` ("user.name") |
| 2 | 1 | Target Property | Property to bind to | `0x08` (TextContent) |

### Custom Elements

Any element type beyond the predefined ones (0x0A-0xFF) is considered a custom element:

1. The element type byte (0x0A-0xFF) serves as an identifier
2. The ID field (string table index) contains the custom element name
3. Renderers implement custom handling based on the name
4. Renderers should skip unrecognized custom elements or treat them as empty containers if no handler is defined.

This approach allows unlimited custom elements without changing the binary format. 

### Internationalization

String table supports multi-language UIs:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 2 | Language Count | Number of languages | `0x03 0x00` (3) |
| 2 | Variable | Language Entries | Language definitions | (See below) |

For each language:

| Offset | Size | Field | Description | Example |
|--------|------|-------|-------------|---------|
| 0 | 1 | Language Code | String index to code | `0x07` ("en-US") |
| 1 | 2 | String Offset | Offset to string table | `0x40 0x01` (320) |

## File Extensions
- Kryon source files use the `.kry` extension (e.g., `interface.kry`).
- Kryon binary files use the `.krb` extension (e.g., `interface.krb`).

## Conclusion

Kryon offers a universal, compact binary format for UI definition across platforms ranging from tiny 8-bit microcontrollers (e.g., Uxn) to modern systems with large applications. By combining efficient binary encoding with rich features and a flexible structure, it enables sophisticated UIs on resource-constrained devices while supporting expansive UIs with a 4-byte file size option.

Its design prioritizes:
1. Minimal memory footprint through binary encoding
2. Flexible yet deterministic parsing
3. Capabilities matching modern UI frameworks
4. Stack-based processing for simple VM compatibility
5. Extensibility for future needs

Kryon represents a significant step forward in cross-platform UI development, particularly for embedded systems, retro computing, and other specialized platforms where existing web technologies prove too resource-intensive.