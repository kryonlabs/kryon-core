# Kryon Binary Format Specification (KRB) v0.2

## Change Log
- v0.2: Formalized as pre-release version. Added explicit `Resource Offset` to Header. Clarified Flag interactions, Layout byte source, indexing bases, and Resource Data field. Header size increased to 42 bytes. Renamed from draft v1.1.
- v0.1: Initial draft corresponding to implicit resource offset.

## Kryon Ecosystem Overview

Kryon consists of two distinct formats:

1.  **Kryon Source Language (.kry)**:
    *   A human-readable, text-based language for defining user interfaces.
    *   Designed for developers to write UI layouts, styles, and behaviors in a simple, expressive syntax.
    *   Files use the `.kry` extension (e.g., `interface.kry`).
    *   Compiled into the binary format for deployment.

2.  **Kryon Binary Format (.krb)**:
    *   A compact, platform-independent binary representation of the UI, as detailed in this specification.
    *   Generated by compiling Kryon source files.
    *   Files use the `.krb` extension (e.g., `interface.krb`) to distinguish them from source files.
    *   Optimized for parsing and rendering on resource-constrained systems.

The Kryon workflow typically involves:
- Writing UI definitions in the Kryon source language (`.kry`).
- Compiling these into the Kryon binary format (`.krb`) using a Kryon compiler.
- Deploying the `.krb` files to target platforms for rendering.

## Design Goals
- **Universal Compatibility**: Works across diverse computing environments, including 8-bit systems like Uxn
- **Compact Representation**: Minimal memory footprint without sacrificing features
- **Performance-Oriented**: Fast parsing, efficient rendering, minimal runtime overhead
- **Feature Complete**: Match or exceed HTML/CSS/JS capabilities where appropriate
- **Extensible**: Designed for future growth while maintaining backward compatibility
- **Stack-Friendly**: Suitable for minimal environments with no dynamic allocation

## File Structure

[File Header]          # Format identification and section offsets
[Element Blocks]       # Starts with App (if present), followed by other elements
[Style Blocks]         # Reusable styles (optional)
[Animation Table]      # Transitions and keyframe animations (optional)
[String Table]         # Text content and identifiers, includes window title
[Resource Table]       # External resources like images and videos (optional)

## 1. File Header (42 bytes)

| Offset | Size | Field            | Description                    | Example             |
|--------|------|------------------|--------------------------------|---------------------|
| 0      | 4    | Magic Number     | Format identifier              | `0x4B 0x52 0x42 0x31` ("KRB1") |
| 4      | 2    | Version          | Format version (Minor << 8 \| Major) | `0x00 0x02` (0.2)   | <!-- Version Changed v0.2 -->
| 6      | 2    | Flags            | Format capabilities            | `0x47 0x00` (styles, animations, resources, app) |
| 8      | 2    | Element Count    | Number of elements             | `0x05 0x00` (5)     |
| 10     | 2    | Style Count      | Number of styles               | `0x02 0x00` (2)     |
| 12     | 2    | Animation Count  | Number of animations           | `0x03 0x00` (3)     |
| 14     | 2    | String Count     | Number of strings              | `0x0A 0x00` (10)    |
| 16     | 2    | Resource Count   | Number of resources            | `0x01 0x00` (1)     |
| 18     | 4    | Element Offset   | Byte offset to elements section| `0x2A 0x00 0x00 0x00` (42) |
| 22     | 4    | Style Offset     | Byte offset to styles section  | `0xCA 0x00 0x00 0x00` (202) |
| 26     | 4    | Animation Offset | Byte offset to animations section| `0xFC 0x00 0x00 0x00` (252) |
| 30     | 4    | String Offset    | Byte offset to strings section | `0x42 0x01 0x00 0x00` (322) |
| 34     | 4    | Resource Offset  | Byte offset to resources section|`0x8A 0x01 0x00 0x00` (394) | <!-- Added v0.2 -->
| 38     | 4    | Total Size       | Total file size in bytes       | `0xB8 0x01 0x00 0x00` (440) | <!-- Offset Changed v0.2 -->

- **Endianness**: **Little-endian** for all multi-byte values.

- **Flags**:
  - Bit 0: `FLAG_HAS_STYLES` (File contains a Style Blocks section)
  - Bit 1: `FLAG_HAS_ANIMATIONS` (File contains an Animation Table section)
  - Bit 2: `FLAG_HAS_RESOURCES` (File contains a Resource Table section)
  - Bit 3: `FLAG_COMPRESSED` (String table uses dictionary compression; *Not currently specified*)
  - Bit 4: `FLAG_FIXED_POINT` (**Must be set** if `VAL_TYPE_PERCENTAGE` is used anywhere; indicates 2-byte 8.8 fixed-point representation)
  - Bit 5: `FLAG_EXTENDED_COLOR` (If set, `VAL_TYPE_COLOR` uses 4-byte RGBA; if clear, uses 1-byte palette index)
  - Bit 6: `FLAG_HAS_APP` (Indicates the first element is an `App` element)
  - Bit 7-15: Reserved

## 2. Element Blocks

Each element represents a UI component. Starts at `Element Offset`. If `FLAG_HAS_APP` is set, the first element must be `App`.

### Element Header (16 bytes)

| Offset | Size | Field          | Description | Example |
|--------|------|----------------|-------------|---------|
| 0      | 1    | Type           | Element type (`ELEM_TYPE_*`) | `0x01` (Container) |
| 1      | 1    | ID             | String table index (0-based) for ID name, or 0 if no ID | `0x01` ("mainContainer") |
| 2      | 2    | Position X     | X coordinate or offset | `0x0A 0x00` (10) |
| 4      | 2    | Position Y     | Y coordinate or offset | `0x0A 0x00` (10) |
| 6      | 2    | Width          | Width in pixels/units | `0xC8 0x00` (200) |
| 8      | 2    | Height         | Height in pixels/units | `0x64 0x00` (100) |
| 10     | 1    | Layout         | **Effective** layout flags for this element (See Layout Byte). **Compiler sets this** based on `PROP_ID_LAYOUT_FLAGS` property or defaults. | `0x05` (Column, Center) | <!-- Clarified v0.2 -->
| 11     | 1    | Style ID       | **1-based** index into Style Blocks array, or 0 for no explicit style. | `0x01` (Style #1) | <!-- Clarified v0.2 -->
| 12     | 1    | Property Count | Number of subsequent properties | `0x02` (2) |
| 13     | 1    | Child Count    | Number of subsequent child references | `0x03` (3) |
| 14     | 1    | Event Count    | Number of subsequent event references | `0x01` (1) |
| 15     | 1    | Animation Count| Number of subsequent animation references | `0x00` (0) |

**Element Types**:
- **Core Elements** (0x00–0x0F): `0x00`:App, `0x01`:Container, `0x02`:Text, `0x03`:Image, `0x04`:Canvas, `0x05`–`0x0F`:Reserved
- **Interactive Elements** (0x10–0x1F): `0x10`:Button, `0x11`:Input, `0x12`–`0x1F`:Reserved
- **Structural Elements** (0x20–0x2F): `0x20`:List, `0x21`:Grid, `0x22`:Scrollable, `0x23`–`0x2F`:Reserved
- **Specialized Elements** (0x30–0xFF): `0x30`:Video, `0x31`–`0xFF`:Custom (Identified by name via `ID` string index)

**Layout Byte**: (*Defines the value in the Element Header's `Layout` field*)
- Bits 0-1: Direction (`00`:Row, `01`:Column, `10`:RowReverse, `11`:ColumnReverse)
- Bits 2-3: Alignment (`00`:Start, `01`:Center, `10`:End, `11`:SpaceBetween)
- Bit 4: Wrap (`0`:NoWrap, `1`:Wrap)
- Bit 5: Grow (`0`:Fixed, `1`:Grow)
- Bit 6: Position (`0`:FlowLayout, `1`:AbsolutePosition)
- Bit 7: Reserved

### Properties

Follow the element header, `Property Count` entries.
**Note:** Interpretation depends on `Value Type` and potentially Header `Flags`.

| Offset   | Size     | Field       | Description                  | Example             |
|----------|----------|-------------|------------------------------|---------------------|
| 0        | 1        | Property ID | Identifier (`PROP_ID_*`)     | `0x01` (BackgroundColor) |
| 1        | 1        | Value Type  | Data type (`VAL_TYPE_*`)     | `0x03` (Color)      |
| 2        | 1        | Size        | Value size in bytes (e.g., 1 or 4 for Color) | `0x04` (4 bytes)    |
| 3        | Variable | Value       | Property value data          | `0xFF 0x00 0x00 0xFF` (Red) |

**Property IDs** (`PROP_ID_*`):
- `0x01`-`0x18`: Standard visual/layout properties (BackgroundColor, ForegroundColor, BorderColor, BorderWidth, BorderRadius, Padding, Margin, TextContent, FontSize, FontWeight, TextAlignment, ImageSource, Opacity, ZIndex, Visibility, Gap, MinWidth, MinHeight, MaxWidth, MaxHeight, AspectRatio, Transform, Shadow, Overflow)
- `0x19`: Custom (Name via string ref)
- `0x1A`: **LayoutFlags** (**Compiler uses this to set Element Header `Layout` byte**) <!-- Clarified v0.2 -->
- **App-Specific** (`0x20`-`0x28`): WindowWidth, WindowHeight, WindowTitle, Resizable, KeepAspect, ScaleFactor, Icon, Version, Author
- Others Reserved

**Value Types** (`VAL_TYPE_*`):
- `0x00`: None
- `0x01`: Byte (1 byte)
- `0x02`: Short (2 bytes)
- `0x03`: **Color** (Size/Format depends on `FLAG_EXTENDED_COLOR`: 4 bytes RGBA if set, 1 byte palette index if clear) <!-- Clarified v0.2 -->
- `0x04`: String Index (1 byte, 0-based index into String Table)
- `0x05`: **Resource Index** (1 byte, 0-based index into Resource Table) <!-- Clarified v0.2 -->
- `0x06`: **Percentage** (Size is 2 bytes, 8.8 fixed-point; `FLAG_FIXED_POINT` **must be set** if this type is used) <!-- Clarified v0.2 -->
- `0x07`: Rectangle (e.g., 8 bytes: 4 shorts x,y,w,h)
- `0x08`: EdgeInsets (e.g., 4 bytes: top,right,bottom,left)
- `0x09`: Enum (Typically 1 byte)
- `0x0A`: Vector (e.g., 4 bytes: 2 shorts x,y)
- `0x0B`: Custom
- Others Reserved

### Events

Follow properties, `Event Count` entries.

| Offset | Size | Field       | Description                  | Example             |
|--------|------|-------------|------------------------------|---------------------|
| 0      | 1    | Event Type  | `EVENT_TYPE_*`               | `0x01` (Click)      |
| 1      | 1    | Callback ID | String table index (0-based) | `0x03` ("handleClick") |

**Event Types**: `0x01`:Click, `0x02`:Press, `0x03`:Release, `0x04`:LongPress, `0x05`:Hover, `0x06`:Focus, `0x07`:Blur, `0x08`:Change, `0x09`:Submit, `0x0A`:Custom. Others Reserved.

### Animation References

Follow events, `Animation Count` entries.

| Offset | Size | Field           | Description                     | Example        |
|--------|------|-----------------|---------------------------------|----------------|
| 0      | 1    | Animation Index | **0-based** index into Anim Table | `0x00` (Anim #0) | <!-- Clarified v0.2 -->
| 1      | 1    | Trigger         | `TRIGGER_TYPE_*`                | `0x01` (Click) |

**Trigger Types**: `0x00`:Auto, `0x01`:Click, `0x02`:Hover, `0x03`:Focus, `0x04`:Load, `0x05`:Custom. Others Reserved.

### Child References

Follow animation references, `Child Count` entries.

| Offset | Size | Field        | Description                               | Example        |
|--------|------|--------------|-------------------------------------------|----------------|
| 0      | 2    | Child Offset | Byte offset *from start of parent header* to child header | `0x50 0x00` (80 bytes) |

## 3. Style Blocks

Define reusable sets of properties. Starts at `Style Offset`.

### Style Header

| Offset   | Size     | Field          | Description                       | Example           |
|----------|----------|----------------|-----------------------------------|-------------------|
| 0        | 1        | ID             | Style identifier (**1-based**)    | `0x01` (Style #1) | <!-- Clarified v0.2 -->
| 1        | 1        | Name Index     | String table index (0-based) for name | `0x02` ("buttonStyle") |
| 2        | 1        | Property Count | Number of properties in this style | `0x04` (4)        |
| 3        | Variable | Properties     | Property definitions (See Property Format) |                   |

## 4. Animation Table

Supports transitions and keyframes. Starts at `Animation Offset`. Indices are **0-based**.

### Transition Animation

| Offset   | Size     | Field           | Description                     | Example          |
|----------|----------|-----------------|---------------------------------|------------------|
| 0        | 1        | Type            | `0x01` (Transition)             |                  |
| 1        | 1        | ID              | Animation index (**0-based**)   | `0x00`           |
| 2        | 2        | Duration        | Milliseconds or Frames          | `0xE8 0x03` (1000ms) |
| 4        | 1        | Timing Function | `TIMING_*` (Linear, EaseInOut...) | `0x01`           |
| 5        | 1        | Property Count  | Number of properties to animate | `0x01`           |
| 6        | Variable | Properties      | Animated properties (ID, Type, Size, StartValue, EndValue) |       |

### Keyframe Animation

| Offset   | Size     | Field          | Description                 | Example         |
|----------|----------|----------------|-----------------------------|-----------------|
| 0        | 1        | Type           | `0x02` (Keyframe)           |                 |
| 1        | 1        | ID             | Animation index (**0-based**) | `0x01`          |
| 2        | 2        | Duration       | Milliseconds or Frames      | `0xD0 0x07` (2000ms)|
| 4        | 1        | Repeat Mode    | `REPEAT_*` (None, Loop...)  | `0x01`          |
| 5        | 1        | Keyframe Count | Number of keyframes         | `0x03`          |
| 6        | Variable | Keyframes      | Keyframe definitions (TimeOffset, PropID, Type, Size, Value) | |

## 5. String Table

Central storage for all text strings. Starts at `String Offset`. Indices are **0-based**. Index 0 may represent an empty/null string.

### String Table Header

| Offset   | Size     | Field        | Description                | Example        |
|----------|----------|--------------|----------------------------|----------------|
| 0        | 2        | String Count | Number of strings          | `0x0A 0x00` (10) |
| 2        | Variable | Strings      | Length-prefixed UTF-8 strings |                |

For each string: `[Length (1 byte)] [UTF-8 Bytes (Variable)]`

## 6. Resource Table

References external resources. Starts at `Resource Offset`. Indices are **0-based**.

### Resource Table Header

| Offset   | Size     | Field          | Description              | Example        |
|----------|----------|----------------|--------------------------|----------------|
| 0        | 2        | Resource Count | Number of resources      | `0x01 0x00` (1) |
| 2        | Variable | Resources      | Resource entries         |                |

For each resource entry:

| Offset   | Size     | Field      | Description                 | Example                |
|----------|----------|------------|-----------------------------|------------------------|
| 0        | 1        | Type       | `RES_TYPE_*` (Image, Font...) | `0x01` (Image)         |
| 1        | 1        | Name Index | String table index (0-based) for name/path | `0x04` ("bg.png") |
| 2        | 1        | Format     | `RES_FORMAT_*` (External, Inline) | `0x00` (External)    |
| 3        | Variable | Data       | Format-specific data        | (See below)            |

**Resource Types** (`RES_TYPE_*`): `0x01`:Image, `0x02`:Font, `0x03`:Sound, `0x04`:Video, `0x05`:Custom. Others Reserved.

**Resource Formats** (`RES_FORMAT_*`):
- `0x00` (External): `Data` is **1 byte**: the String Table index (0-based) of the resource path/URL. Total entry size: 4 bytes. <!-- Clarified v0.2 -->
- `0x01` (Inline): `Data` is **`[Size (2 bytes)] [Raw Bytes (Variable)]`**. Total entry size: 3 + Size + Raw Bytes length. (*Parsing/Writing requires handling this variable part*).

## Stack-Based Considerations & Optimizations

These are guidelines for compilers/renderers targeting constrained systems:
- Use 8-bit indices where possible.
- Simplify numeric values (palette colors, 8-bit coords, frame-based time).
- Prefer fixed element sizes.
- Precompute layouts.
- Consider String Table compression.
- Simplify animations.
- Use memory-efficient stream parsing.

## Conclusion

Kryon KRB v0.2 defines a pre-release specification for a universal, compact binary UI format. By adding an explicit Resource Offset and clarifying potential ambiguities from earlier drafts, this version aims for improved clarity and implementation consistency while retaining the core design goals of compactness and performance across diverse platforms. It serves as the target format for initial Kryon compiler and runtime development (e.g., v0.1.0).