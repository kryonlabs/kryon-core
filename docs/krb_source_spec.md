# Kryon Binary Format Specification (KRB) v0.3

## Change Log
*   **v0.3**: Added `Custom Prop Count` (1 byte) to Element Header, increasing header size to 17 bytes. Defined structure for optional `Custom Properties` section following standard properties within Element Blocks. Clarified `ELEM_TYPE_CUSTOM` usage and `PROP_ID_CUSTOM` (0x19) as a data blob. Added documentation notes emphasizing compiler expansion (`.kry`'s `Define`) as the preferred method for component abstraction over direct KRB custom types/properties for portability. Version number updated.
*   v0.2: Formalized as pre-release version. Added explicit `Resource Offset` to Header. Clarified Flag interactions, Layout byte source, indexing bases, and Resource Data field. Header size 42 bytes. Renamed from draft v1.1.
*   v0.1: Initial draft corresponding to implicit resource offset.

## Kryon Ecosystem Overview

Kryon consists of two distinct formats and typically a compiler:

1.  **Kryon Source Language (.kry)**:
    *   A human-readable, text-based language for defining user interfaces, including features like component definition (`Define`) for abstraction.
    *   Defined in a separate specification (`kry_source_spec_v1.0.md` or similar).
    *   Compiled into the binary format (.krb).

2.  **Kryon Binary Format (.krb)**:
    *   A compact, platform-independent binary representation of the UI, **as detailed in this specification (v0.3).**
    *   Generated by compiling `.kry` source files.
    *   Files use the `.krb` extension.
    *   Optimized for parsing and rendering on resource-constrained systems.


3.  **Kryon Compiler (`kryonc`)**:
    *   Translates `.kry` source files into `.krb` binary files.
    *   Expands `.kry` `Define` component usage into standard KRB elements.
    *   Maps standard `.kry` properties to standard KRB properties.
    *   **Crucially, encodes component-specific properties (like `position` from a `TabBar`) declared in `.kry` `Properties` blocks into the KRB `Custom Properties` section for later interpretation.**

**Runtime Expectation:** Runtimes parsing `.krb` files must understand the standard elements and properties defined here. KRB v0.3 introduces an optional **Custom Properties** section within Element Blocks. This allows compilers to embed application-specific key-value data (like `position="bottom"` originating from a custom `.kry` component like `<TabBar>`) directly into the KRB. **Crucially, the interpretation and handling of these Custom Properties is the responsibility of the specific runtime environment.** Standard runtimes might ignore custom properties they don't recognize. Compiler expansion (`Define` in `.kry`) that resolves components entirely into standard elements *without* relying on runtime interpretation of custom properties remains the recommended approach for maximum portability, but this Custom Properties mechanism enables runtime-specific handling when required.

## Design Goals
*   **Universal Compatibility**: Works across diverse computing environments, including 8-bit systems.
*   **Compact Representation**: Minimal memory footprint.
*   **Performance-Oriented**: Fast parsing, efficient rendering.
*   **Feature Complete**: Aims to cover common UI needs.
*   **Extensible**: Allows for custom element types and properties, although standard types are preferred for maximum compatibility and simplicity.
*   **Stack-Friendly**: Suitable for minimal environments.

## File Structure

[File Header]          # Format identification and section offsets
[Element Blocks]       # Starts with App (if present), followed by other elements
[Style Blocks]         # Reusable styles (optional)
[Animation Table]      # Transitions and keyframe animations (optional)
[String Table]         # Text content and identifiers
[Resource Table]       # External resources (optional)

## 1. File Header (42 bytes)

| Offset | Size | Field            | Description                    | Example             |
|--------|------|------------------|--------------------------------|---------------------|
| 0      | 4    | Magic Number     | Format identifier              | `0x4B 0x52 0x42 0x31` ("KRB1") |
| 4      | 2    | Version          | Format version (Minor << 8 \| Major) | **`0x00 0x03` (0.3)** | <!-- Version Changed v0.3 -->
| 6      | 2    | Flags            | Format capabilities            | `0x47 0x00` (styles, animations, resources, app) |
| 8      | 2    | Element Count    | Number of elements             | `0x05 0x00` (5)     |
| 10     | 2    | Style Count      | Number of styles               | `0x02 0x00` (2)     |
| 12     | 2    | Animation Count  | Number of animations           | `0x03 0x00` (3)     |
| 14     | 2    | String Count     | Number of strings              | `0x0A 0x00` (10)    |
| 16     | 2    | Resource Count   | Number of resources            | `0x01 0x00` (1)     |
| 18     | 4    | Element Offset   | Byte offset to elements section| `0x2A 0x00 0x00 0x00` (42) |
| 22     | 4    | Style Offset     | Byte offset to styles section  | `0xCA 0x00 0x00 0x00` (202) |
| 26     | 4    | Animation Offset | Byte offset to animations section| `0xFC 0x00 0x00 0x00` (252) |
| 30     | 4    | String Offset    | Byte offset to strings section | `0x42 0x01 0x00 0x00` (322) |
| 34     | 4    | Resource Offset  | Byte offset to resources section|`0x8A 0x01 0x00 0x00` (394) |
| 38     | 4    | Total Size       | Total file size in bytes       | `0xB8 0x01 0x00 0x00` (440) |

*   **Endianness**: **Little-endian** for all multi-byte values.
*   **Flags**: (Bit definitions remain unchanged from v0.2)
    *   Bit 0: `FLAG_HAS_STYLES`
    *   Bit 1: `FLAG_HAS_ANIMATIONS`
    *   Bit 2: `FLAG_HAS_RESOURCES`
    *   Bit 3: `FLAG_COMPRESSED` (*Not currently specified*)
    *   Bit 4: `FLAG_FIXED_POINT` (Required if `VAL_TYPE_PERCENTAGE` used)
    *   Bit 5: `FLAG_EXTENDED_COLOR` (4-byte RGBA vs 1-byte palette index)
    *   Bit 6: `FLAG_HAS_APP` (First element is `App`)
    *   Bit 7-15: Reserved

## 2. Element Blocks

Starts at `Element Offset` from the header. Contains `Element Count` blocks.

### Element Header (17 bytes)

| Offset | Size | Field                 | Description                                                | Example             |
|--------|------|-----------------------|------------------------------------------------------------|---------------------|
| 0      | 1    | Type                  | Element type (`ELEM_TYPE_*`)                               | `0x01` (Container)  |
| 1      | 1    | ID                    | String table index (0-based) for ID name, or 0 if no ID    | `0x01` ("main")     |
| 2      | 2    | Position X            | X coordinate or offset                                     | `0x0A 0x00` (10)    |
| 4      | 2    | Position Y            | Y coordinate or offset                                     | `0x0A 0x00` (10)    |
| 6      | 2    | Width                 | Width in pixels/units                                      | `0xC8 0x00` (200)   |
| 8      | 2    | Height                | Height in pixels/units                                     | `0x64 0x00` (100)   |
| 10     | 1    | Layout                | Effective layout flags (See Layout Byte). Compiler sets.   | `0x05` (Col, Center)|
| 11     | 1    | Style ID              | 1-based index into Style Blocks array, or 0 for no style.  | `0x01` (Style #1)   |
| 12     | 1    | Property Count        | Number of *standard* subsequent properties                 | `0x02` (2)          |
| 13     | 1    | Child Count           | Number of subsequent child references                      | `0x03` (3)          |
| 14     | 1    | Event Count           | Number of subsequent event references                      | `0x01` (1)          |
| 15     | 1    | Animation Count       | Number of subsequent animation references                  | `0x00` (0)          |
| **16** | **1**| **Custom Prop Count** | **Number of *custom* key-value properties following standard props.** | **`0x01` (1)**      | 

**Element Types** (`ELEM_TYPE_*`):
*   **Core Elements** (0x00–0x0F): `0x00`:App, `0x01`:Container, `0x02`:Text, `0x03`:Image, `0x04`:Canvas, `0x05`–`0x0F`:Reserved
*   **Interactive Elements** (0x10–0x1F): `0x10`:Button, `0x11`:Input, `0x12`–`0x1F`:Reserved
*   **Structural Elements** (0x20–0x2F): `0x20`:List, `0x21`:Grid, `0x22`:Scrollable, `0x23`–`0x2F`:Reserved
*   **Specialized Elements** (0x30–0xFF): `0x30`:Video, `0x31`–`0xFF`: **Custom**
    *   **Note on Custom Types (v0.3):** Types `0x31-0xFF` denote application-specific elements requiring full runtime interpretation. The `ID` field (String Table index) may identify the type. **Using standard element types (like `Container`) combined with the Custom Properties section below is often preferred over defining entirely new `ELEM_TYPE_CUSTOM` types for component representation if only specific behaviors (like positioning) need runtime interpretation.** Standard runtimes may ignore unknown custom types.

**Layout Byte**: (*Defines the value in the Element Header's `Layout` field*)
*   Bits 0-1: Direction (`00`:Row, `01`:Column, `10`:RowReverse, `11`:ColumnReverse)
*   Bits 2-3: Alignment (`00`:Start, `01`:Center, `10`:End, `11`:SpaceBetween)
*   Bit 4: Wrap (`0`:NoWrap, `1`:Wrap)
*   Bit 5: Grow (`0`:Fixed, `1`:Grow)
*   Bit 6: Position (`0`:FlowLayout, `1`:AbsolutePosition)
*   Bit 7: Reserved

### Standard Properties

Follow the element header, `Property Count` entries.

| Offset   | Size     | Field       | Description                                          | Example             |
|----------|----------|-------------|------------------------------------------------------|---------------------|
| 0        | 1        | Property ID | Standard Identifier (`PROP_ID_*`)                    | `0x01` (BgColor)    |
| 1        | 1        | Value Type  | Data type (`VAL_TYPE_*`)                             | `0x03` (Color)      |
| 2        | 1        | Size        | Value size in bytes (e.g., 1 or 4 for Color)         | `0x04` (4 bytes)    |
| 3        | Variable | Value       | Property value data according to Type and Size       | `0xFF0000FF` (Red)  |

**Property IDs** (`PROP_ID_*`):
*   `0x01`-`0x18`: Standard visual/layout properties (BackgroundColor, ForegroundColor, BorderColor, BorderWidth, BorderRadius, Padding, Margin, TextContent, FontSize, FontWeight, TextAlignment, ImageSource, Opacity, ZIndex, Visibility, Gap, MinWidth, MinHeight, MaxWidth, MaxHeight, AspectRatio, Transform, Shadow, Overflow)
*   `0x19`: **Custom Data Blob** - Value is arbitrary binary data. `Value Type` should indicate format (e.g., `VAL_TYPE_CUSTOM`), `Size` gives length. The `ID` field in the Element Header (or another standard property) should provide context for runtime interpretation. *(Clarified v0.3)*
*   `0x1A`: **LayoutFlags** - Compiler uses this property from the source (`.kry`) to compute and set the final `Layout` byte in the Element Header.
*   **App-Specific** (`0x20`-`0x28`): WindowWidth, WindowHeight, WindowTitle, Resizable, KeepAspect, ScaleFactor, Icon, Version, Author (Only valid on `ELEM_TYPE_APP`)
*   Others Reserved

**Value Types** (`VAL_TYPE_*`):
*   `0x00`: None
*   `0x01`: Byte (1 byte)
*   `0x02`: Short (2 bytes, little-endian)
*   `0x03`: **Color** (Size/Format depends on `FLAG_EXTENDED_COLOR`: 4 bytes RGBA if set, 1 byte palette index if clear)
*   `0x04`: String Index (1 byte, 0-based index into String Table)
*   `0x05`: **Resource Index** (1 byte, 0-based index into Resource Table)
*   `0x06`: **Percentage** (Size is 2 bytes, 8.8 fixed-point, little-endian; `FLAG_FIXED_POINT` must be set if used)
*   `0x07`: Rectangle (e.g., 8 bytes: 4 shorts x,y,w,h)
*   `0x08`: EdgeInsets (e.g., 4 bytes/shorts: top,right,bottom,left)
*   `0x09`: Enum (Typically 1 byte, specific meanings depend on Property ID)
*   `0x0A`: Vector (e.g., 4 bytes: 2 shorts x,y)
*   `0x0B`: Custom (Indicates application-specific interpretation, often used with `PROP_ID_CUSTOM_DATA_BLOB`)
*   Others Reserved

### Custom Properties (Optional - New in v0.3)

Follows the Standard Properties section. Contains `Custom Prop Count` entries. This section provides a structured way to embed key-value data directly in the KRB **for runtime interpretation**.

**Purpose:** Allows custom components defined in `.kry` (e.g., using `Define`) to pass component-specific properties (like `position`, `orientation`, custom data bindings) through the compiler into the `.krb` file. The compiler translates these into key-value pairs here.

**Runtime Responsibility:** The runtime environment is responsible for:
1.  Checking for the presence of custom properties on elements it processes.
2.  Interpreting the meaning of specific keys (e.g., "position", "customBehavior").
3.  Implementing the corresponding layout, rendering, or behavioral logic based on the values found.
    *   *Example:* A runtime might check any `Container` for a `custom_prop[key="position"]`. If found, it applies specific layout logic to that container relative to its siblings based on the property's value ("top", "bottom", etc.).

**Note:** Using this section ties the `.krb` file's full behavior to a runtime capable of interpreting these specific custom property keys. Prefer compiler resolution into standard properties whenever possible for better portability.

Each custom property entry structure:

| Offset   | Size     | Field      | Description                                           | Example                      |
|----------|----------|------------|-------------------------------------------------------|------------------------------|
| 0        | 1        | Key Index  | String table index (0-based) for the property key name | `0x05` ("position")        |
| 1        | 1        | Value Type | Data type (`VAL_TYPE_*`) for the value                | `0x04` (String Index)        |
| 2        | 1        | Value Size | Value size in bytes (e.g., 1 for String Index)        | `0x01` (1 byte)             |
| 3        | Variable | Value      | Property value data according to Type and Size        | `0x08` ("bottom" string index) |

### Events

Follow Custom Properties (if any). Contains `Event Count` entries.

| Offset | Size | Field       | Description                          | Example             |
|--------|------|-------------|--------------------------------------|---------------------|
| 0      | 1    | Event Type  | `EVENT_TYPE_*`                       | `0x01` (Click)      |
| 1      | 1    | Callback ID | String table index (0-based) for function name | `0x03` ("handleClick") |

**Event Types** (`EVENT_TYPE_*`): `0x01`:Click, `0x02`:Press, `0x03`:Release, `0x04`:LongPress, `0x05`:Hover, `0x06`:Focus, `0x07`:Blur, `0x08`:Change, `0x09`:Submit, `0x0A`:Custom (Runtime defined). Others Reserved.

### Animation References

Follow Events. Contains `Animation Count` entries.

| Offset | Size | Field           | Description                             | Example        |
|--------|------|-----------------|-----------------------------------------|----------------|
| 0      | 1    | Animation Index | 0-based index into Animation Table      | `0x00` (Anim #0) |
| 1      | 1    | Trigger         | `TRIGGER_TYPE_*` that starts animation | `0x01` (Click)   |

**Trigger Types** (`TRIGGER_TYPE_*`): `0x00`:Auto, `0x01`:Click, `0x02`:Hover, `0x03`:Focus, `0x04`:Load, `0x05`:Custom (Runtime defined). Others Reserved.

### Child References

Follow Animation References. Contains `Child Count` entries.

| Offset | Size | Field        | Description                                                 | Example        |
|--------|------|--------------|-------------------------------------------------------------|----------------|
| 0      | 2    | Child Offset | Byte offset *from start of this parent's header* to child header | `0x5A 0x00` (90) |

## 3. Style Blocks

Starts at `Style Offset`. Contains `Style Count` blocks. Defines reusable sets of *standard* properties.

### Style Header

| Offset   | Size     | Field          | Description                                   | Example           |
|----------|----------|----------------|-----------------------------------------------|-------------------|
| 0        | 1        | ID             | Style identifier (**1-based**)                | `0x01` (Style #1) |
| 1        | 1        | Name Index     | String table index (0-based) for style name   | `0x02` ("btn")    |
| 2        | 1        | Property Count | Number of standard properties in this style   | `0x04` (4)        |
| 3        | Variable | Properties     | Standard Property definitions (ID, Type, Size, Value) |                   |

## 4. Animation Table

Starts at `Animation Offset`. Contains `Animation Count` entries. Indices are **0-based**. Animations operate on *standard* properties.

### Transition Animation

| Offset   | Size     | Field           | Description                         | Example          |
|----------|----------|-----------------|-------------------------------------|------------------|
| 0        | 1        | Type            | `0x01` (Transition)                 |                  |
| 1        | 1        | ID              | Animation index (**0-based**)       | `0x00`           |
| 2        | 2        | Duration        | Milliseconds or Frames (little-endian)| `0xE8 0x03` (1000ms)|
| 4        | 1        | Timing Function | `TIMING_*` (Linear, EaseInOut...)   | `0x01`           |
| 5        | 1        | Property Count  | Number of standard properties to animate | `0x01`           |
| 6        | Variable | Properties      | Animated props (ID, Type, Size, StartValue, EndValue) |       |

### Keyframe Animation

| Offset   | Size     | Field          | Description                             | Example         |
|----------|----------|----------------|-----------------------------------------|-----------------|
| 0        | 1        | Type           | `0x02` (Keyframe)                       |                 |
| 1        | 1        | ID             | Animation index (**0-based**)           | `0x01`          |
| 2        | 2        | Duration       | Milliseconds or Frames (little-endian)  | `0xD0 0x07` (2000ms)|
| 4        | 1        | Repeat Mode    | `REPEAT_*` (None, Loop...)              | `0x01`          |
| 5        | 1        | Keyframe Count | Number of keyframes                     | `0x03`          |
| 6        | Variable | Keyframes      | Keyframe definitions (TimeOffset, PropID, Type, Size, Value) | |

## 5. String Table

Starts at `String Offset`. Contains `String Count` strings. Indices are **0-based**. Index 0 may represent an empty/null string.

### String Table Header

| Offset   | Size     | Field        | Description                       | Example        |
|----------|----------|--------------|-----------------------------------|----------------|
| 0        | 2        | String Count | Number of strings (little-endian) | `0x0A 0x00` (10) |
| 2        | Variable | Strings      | Series of length-prefixed UTF-8 strings |                |

For each string: `[Length (1 byte)] [UTF-8 Bytes (Variable)]`

## 6. Resource Table

Starts at `Resource Offset`. Contains `Resource Count` entries. Indices are **0-based**.

### Resource Table Header

| Offset   | Size     | Field          | Description                       | Example        |
|----------|----------|----------------|-----------------------------------|----------------|
| 0        | 2        | Resource Count | Number of resources (little-endian)| `0x01 0x00` (1) |
| 2        | Variable | Resources      | Series of resource entries        |                |

For each resource entry:

| Offset   | Size     | Field      | Description                                  | Example                |
|----------|----------|------------|----------------------------------------------|------------------------|
| 0        | 1        | Type       | `RES_TYPE_*` (Image, Font...)                | `0x01` (Image)         |
| 1        | 1        | Name Index | String table index (0-based) for name/path   | `0x04` ("bg.png")      |
| 2        | 1        | Format     | `RES_FORMAT_*` (External, Inline)            | `0x00` (External)      |
| 3        | Variable | Data       | Format-specific data (Path index or Size+Bytes)| (See below)            |

**Resource Types** (`RES_TYPE_*`): `0x01`:Image, `0x02`:Font, `0x03`:Sound, `0x04`:Video, `0x05`:Custom. Others Reserved.

**Resource Formats** (`RES_FORMAT_*`):
*   `0x00` (External): `Data` is **1 byte**: the String Table index (0-based) of the resource path/URL. Total entry size: 4 bytes.
*   `0x01` (Inline): `Data` is **`[Size (2 bytes, little-endian)] [Raw Bytes (Variable)]`**. Total entry size: 3 + Size + Raw Bytes length.

## Stack-Based Considerations & Optimizations

*   **Custom Property Interpretation Overhead:** Relying heavily on runtime interpretation of Custom Properties adds complexity and potential performance cost to the runtime compared to handling pre-resolved standard properties. Use judiciously for behaviors the compiler cannot fully resolve.
*   **Minimize Custom Data:** Relying heavily on `ELEM_TYPE_CUSTOM` or the Custom Properties section increases runtime complexity and KRB file size. Prefer compiler abstractions (`Define` in `.kry`) that resolve to standard KRB elements and properties whenever possible.
*   Use 8-bit indices where feasible (String Table, Resource Table indices if counts are low).
*   Simplify numeric values (palette colors via `FLAG_EXTENDED_COLOR=0`, frame-based time).
*   Prefer fixed element sizes where appropriate.
*   Precompute layouts during compilation (Compiler sets `Layout` byte).
*   Consider String Table compression (future extension via `FLAG_COMPRESSED`).
*   Simplify or omit animations if not essential.
*   Use memory-efficient stream parsing in runtimes.

## Conclusion

Kryon KRB v0.3 defines a specification for a universal, compact binary UI format. It adds an optional **Custom Properties** mechanism allowing component-specific data defined in `.kry` to be passed into the binary file. **The interpretation and handling of this custom data is explicitly the responsibility of the target runtime environment.** While compiler expansion into purely standard elements/properties remains ideal for portability, this feature enables richer runtime-specific behaviors when needed.